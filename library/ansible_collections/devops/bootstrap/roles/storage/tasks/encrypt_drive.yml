---
- name: Fail if disk for encryption is not defined
  fail:
    msg: You need to provide disk to encrypt in format '/dev/sda'
  when: enc_drive_name is not defined or enc_drive_name is not match("/dev/.+")

- name: Check '{{ enc_drive_name }}' exists
  ansible.builtin.stat:
    path: "{{ enc_drive_name }}"
  register: drive_stat

- name: Fail if drive does not exists
  ansible.builtin.fail:
    msg: Drive '{{ enc_drive_name }}' does not exists
  when: not drive_stat.stat.exists

- name: Install dependencies
  ansible.builtin.package:
    name: jq
    state: present
  become: true

- name: Find root drive
  ansible.builtin.shell: >
    lsblk -oNAME,MOUNTPOINT -J | 
    jq -r '.blockdevices[] | . as $bd | .. | objects | select(.mountpoint == "/") | $bd.name'
  register: root_drive_info

- name: Fail if this drive contains root
  ansible.builtin.fail:
    msg: "{{ enc_drive_name }} contains root partition"
  when: '"/dev/" + root_drive_info.stdout == enc_drive_name'

- name: Encrypt second drive
  community.crypto.luks_device:
    device: "{{ enc_drive_name }}"
    state: "present"
    passphrase: "{{ crypt_passphrase }}"
  become: true

